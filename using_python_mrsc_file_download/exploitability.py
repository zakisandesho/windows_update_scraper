import pandas as pd
import asyncio
from playwright.async_api import async_playwright
import os

input_file = r"windows_update_scraper\using_python_mrsc_file_download\filtered_updates.xlsx"
output_file = os.path.join(os.path.dirname(__file__), "exploitability_extract.xlsx")
base_url = "https://msrc.microsoft.com/update-guide/vulnerability/"

def extract_columns(input_file):
    df = pd.read_excel(input_file)
    filtered_df = df.iloc[:, [0]].copy()
    filtered_df.columns = ["Details"]
    return filtered_df

async def fetch_exploitability(context, cve):
    url = f"{base_url}{cve}"
    try:
        page = await context.new_page()
        await page.goto(url, timeout=15000)
        # Wait for spinner to disappear if present
        try:
            await page.wait_for_selector('.ms-Spinner', state='detached', timeout=5000)
        except:
            pass
        # Wait for <dl> to appear
        try:
            await page.wait_for_selector('dl[class^="css-"]', timeout=5000)
        except Exception as e:
            print(f"dl.css-354 not found for {cve}: {e}")
            await page.close()
            return "Unknown"
        # Find all <dt> elements
        dts = await page.query_selector_all('dl[class^="css-"] dt')
        for dt in dts:
            text = (await dt.inner_text()).strip()
            if text == "Exploitability assessment":
                dd = await dt.evaluate_handle("node => node.nextElementSibling")
                value = (await dd.inner_text()).strip()
                await page.close()
                return value
        # Debug: print page HTML if not found
        html = await page.content()
        print(f"Exploitability not found for {cve}. Page HTML:\n{html[:1000]}")
        await page.close()
        return "Unknown"
    except Exception as e:
        print(f"Error fetching exploitability for {url}: {e}")
        return "Unknown"

async def add_exploitability(df, concurrency=5):
    exploitabilities = [None] * len(df)
    async with async_playwright() as playwright:
        browser = await playwright.chromium.launch(headless=True)
        context = await browser.new_context()
        sem = asyncio.Semaphore(concurrency)

        async def fetch_and_store(idx, cve):
            if isinstance(cve, str) and cve.startswith("CVE-"):
                async with sem:
                    print(f"Fetching: {base_url}{cve}")
                    exploitabilities[idx] = await fetch_exploitability(context, cve)
            else:
                exploitabilities[idx] = "Unknown"

        tasks = [fetch_and_store(idx, cve) for idx, cve in enumerate(df["Details"])]
        await asyncio.gather(*tasks)
        await browser.close()
    df["Exploitability"] = exploitabilities
    return df

def write_excel(df, output_file):
    with pd.ExcelWriter(output_file, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='Sheet1')
        worksheet = writer.sheets['Sheet1']
        for row_num, value in enumerate(df["Details"], start=1):
            if isinstance(value, str) and value.startswith("CVE-"):
                url = base_url + value
                worksheet.write_url(row_num, 0, url, string=value)
    print(f"Output written to {output_file}")

def main():
    filtered_df = extract_columns(input_file)
    filtered_df = asyncio.run(add_exploitability(filtered_df, concurrency=5))
    write_excel(filtered_df, output_file)

if __name__ == "__main__":
    main()